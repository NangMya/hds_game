{
    "sourceFile": "app/work_bk_static.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1769066758789,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1769066758789,
            "name": "Commit-0",
            "content": "\"use client\";\r\nimport { useState, useEffect, useRef } from \"react\";\r\nimport html2canvas from \"html2canvas\";\r\n\r\ninterface Box {\r\n  id: number;\r\n  x: number;\r\n  y: number;\r\n  collected: boolean;\r\n}\r\n\r\n// for 100 ft\r\n// const ROOM_SIZE_FT = 100;\r\n// const PIXEL_SCALE = 20;\r\n// const BOX_COUNT = 5;\r\n// const STEP_LENGTH = 0.8;\r\n// const PICKUP_RANGE = 2.5;\r\n\r\n// for 20 ft\r\nconst ROOM_SIZE_FT = 20;\r\nconst PIXEL_SCALE = 100;\r\nconst BOX_COUNT = 5;\r\nconst STEP_LENGTH = 0.5;\r\nconst PICKUP_RANGE = 1;\r\n\r\nexport default function RadarVirtualWorldFix() {\r\n  const [playerPosition, setPlayerPosition] = useState({\r\n    x: ROOM_SIZE_FT / 2,\r\n    y: ROOM_SIZE_FT / 2,\r\n  });\r\n  const [boxes, setBoxes] = useState<Box[]>([]);\r\n  const [inventory, setInventory] = useState<number[]>([]);\r\n  const [nearestInfo, setNearestInfo] = useState({\r\n    distance: 0,\r\n    angle: 0,\r\n    id: -1,\r\n  });\r\n  const [message, setMessage] = useState(\"\");\r\n  const [isStarted, setIsStarted] = useState(false);\r\n  const [showBag, setShowBag] = useState(false);\r\n  const [mag, setMag] = useState(0);\r\n  const [isOutOfBounds, setIsOutOfBounds] = useState(false);\r\n  const boxesRef = useRef<Box[]>([]);\r\n  const inventoryRef = useRef<HTMLDivElement>(null);\r\n\r\n  const gameRef = useRef<HTMLDivElement>(null);\r\n  const pos = useRef({ x: ROOM_SIZE_FT / 2, y: ROOM_SIZE_FT / 2 });\r\n  const stepCooldown = useRef(0);\r\n  const deviceOrientation = useRef(0);\r\n  useEffect(() => {\r\n    boxesRef.current = boxes;\r\n  }, [boxes]);\r\n\r\n  useEffect(() => {\r\n    const newBoxes: any[] = [];\r\n    const center = ROOM_SIZE_FT / 2;\r\n    const maxRadius = Math.max(0, ROOM_SIZE_FT / 2 - 5);\r\n    for (let i = 0; i < BOX_COUNT; i++) {\r\n      const angle = Math.random() * Math.PI * 2;\r\n      const radius = Math.sqrt(Math.random()) * maxRadius;\r\n      newBoxes.push({\r\n        id: i,\r\n        x: center + radius * Math.cos(angle),\r\n        y: center + radius * Math.sin(angle),\r\n        collected: false,\r\n      });\r\n    }\r\n    setBoxes(newBoxes);\r\n    boxesRef.current = newBoxes;\r\n    updateNearest(pos.current, newBoxes);\r\n    // updateNearest(pos.current, boxesRef.current);\r\n  }, [ROOM_SIZE_FT]);\r\n\r\n  const updateNearest = (\r\n    currentPos: { x: number; y: number },\r\n    currentBoxes: Box[],\r\n  ) => {\r\n    const active = currentBoxes.filter((b) => !b.collected);\r\n    if (active.length === 0) {\r\n      setNearestInfo({ distance: 0, angle: 0, id: -1 });\r\n      return;\r\n    }\r\n    let minD = Infinity;\r\n    let target = active[0];\r\n    active.forEach((b) => {\r\n      const d = Math.sqrt(\r\n        (currentPos.x - b.x) ** 2 + (currentPos.y - b.y) ** 2,\r\n      );\r\n      if (d < minD) {\r\n        minD = d;\r\n        target = b;\r\n      }\r\n    });\r\n    const angle =\r\n      Math.atan2(target.y - currentPos.y, target.x - currentPos.x) *\r\n      (180 / Math.PI);\r\n    setNearestInfo({ distance: minD, angle, id: target.id });\r\n  };\r\n\r\n  const onBoxClick = (box: Box) => {\r\n    const dist = Math.sqrt(\r\n      (pos.current.x - box.x) ** 2 + (pos.current.y - box.y) ** 2,\r\n    );\r\n    if (dist <= PICKUP_RANGE) {\r\n      const updatedBoxes = boxes.map((b) =>\r\n        b.id === box.id ? { ...b, collected: true } : b,\r\n      );\r\n      setBoxes(updatedBoxes);\r\n      setInventory((prev) => [...prev, box.id]);\r\n      updateNearest(pos.current, updatedBoxes);\r\n      setMessage(\"Added to Bag! ðŸŽ’\");\r\n    } else {\r\n      setMessage(`Too far! Move closer.`);\r\n    }\r\n    setTimeout(() => setMessage(\"\"), 2000);\r\n  };\r\n\r\n  const startJourney = async () => {\r\n    const DM = DeviceMotionEvent as any;\r\n    if (typeof DM.requestPermission === \"function\") {\r\n      const res = await DM.requestPermission();\r\n      if (res === \"granted\") initGame();\r\n    } else {\r\n      initGame();\r\n    }\r\n  };\r\n\r\n  const initGame = () => {\r\n    window.addEventListener(\"devicemotion\", (e) => {\r\n      const acc = e.acceleration;\r\n      if (!acc || acc.x === null) return;\r\n\r\n      const m = Math.sqrt(acc.x ** 2 + acc.y! ** 2 + acc.z! ** 2);\r\n      setMag(m);\r\n\r\n      const now = Date.now();\r\n      if (m > 0.4 && m < 0.6 && now > stepCooldown.current) {\r\n        stepCooldown.current = now + 600;\r\n\r\n        const alpha = deviceOrientation.current;\r\n        pos.current.x += Math.sin(alpha) * STEP_LENGTH;\r\n        pos.current.y -= Math.cos(alpha) * STEP_LENGTH;\r\n\r\n        setIsOutOfBounds(\r\n          pos.current.x < 0 ||\r\n            pos.current.x > ROOM_SIZE_FT ||\r\n            pos.current.y < 0 ||\r\n            pos.current.y > ROOM_SIZE_FT,\r\n        );\r\n\r\n        pos.current.x = Math.max(\r\n          -0.5,\r\n          Math.min(ROOM_SIZE_FT + 0.5, pos.current.x),\r\n        );\r\n        pos.current.y = Math.max(\r\n          -0.5,\r\n          Math.min(ROOM_SIZE_FT + 0.5, pos.current.y),\r\n        );\r\n\r\n        //  ONLY remaining boxes are considered\r\n        updateNearest(pos.current, boxesRef.current);\r\n\r\n        setPlayerPosition({ ...pos.current });\r\n      }\r\n    });\r\n\r\n    window.addEventListener(\"deviceorientation\", (e) => {\r\n      let alpha = (e as any).webkitCompassHeading || 360 - (e.alpha || 0);\r\n      deviceOrientation.current = (alpha * Math.PI) / 180;\r\n    });\r\n    setIsStarted(true);\r\n  };\r\n\r\n  return (\r\n    <main\r\n      ref={gameRef}\r\n      className={`fixed inset-0 w-full h-[100vh] bg-black overflow-hidden flex flex-col items-center justify-center font-sans select-none touch-none transition-all duration-300 ${isOutOfBounds ? \"ring-[16px] ring-inset ring-red-600/80 shadow-[0_0_60px_rgba(220,38,38,0.8)]\" : \"\"}`}\r\n    >\r\n      {!isStarted && (\r\n        <div className=\"absolute inset-0 z-[200] flex items-center justify-center bg-black\">\r\n          <button\r\n            onClick={startJourney}\r\n            className=\"bg-indigo-600 text-white px-10 py-5 rounded-full font-black tracking-widest active:scale-95 transition-all\"\r\n          >\r\n            START JOURNEY\r\n          </button>\r\n        </div>\r\n      )}\r\n\r\n      {/* Bag & Distance */}\r\n      {isStarted && (\r\n        <>\r\n          <button\r\n            onClick={() => setShowBag(true)}\r\n            className=\"absolute top-6 right-6 z-[200] w-14 h-14 bg-zinc-900 border border-white/20 rounded-full flex items-center justify-center text-2xl shadow-xl active:scale-90\"\r\n          >\r\n            ðŸŽ’{\" \"}\r\n            {inventory.length > 0 && (\r\n              <span className=\"absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center font-bold\">\r\n                {inventory.length}\r\n              </span>\r\n            )}\r\n          </button>\r\n          <div className=\"absolute top-10 z-[200] text-center pointer-events-none\">\r\n            <div className=\"bg-zinc-900/90 px-6 py-2 rounded-2xl border border-white/10 backdrop-blur-md\">\r\n              <p className=\"text-[10px] text-zinc-500 font-bold uppercase tracking-widest\">\r\n                Target\r\n              </p>\r\n              <div className=\"text-white font-mono text-3xl font-black\">\r\n                {nearestInfo.id === -1\r\n                  ? \"---\"\r\n                  : `${nearestInfo.distance.toFixed(1)} FT`}\r\n              </div>\r\n              {message && (\r\n                <p className=\"text-yellow-400 text-[10px] mt-1 font-bold animate-pulse\">\r\n                  {message}\r\n                </p>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </>\r\n      )}\r\n\r\n      {/* World Map Container */}\r\n      <div className=\"relative w-full h-full flex items-center justify-center overflow-visible\">\r\n        <div\r\n          className=\"absolute transition-transform duration-500 ease-out z-[50]\"\r\n          style={{\r\n            transform: `translate(${(ROOM_SIZE_FT / 2 - playerPosition.x) * PIXEL_SCALE}px, ${(ROOM_SIZE_FT / 2 - playerPosition.y) * PIXEL_SCALE}px)`,\r\n          }}\r\n        >\r\n          <div\r\n            className=\"absolute rounded-full border border-white/5\"\r\n            style={{\r\n              width: 90 * PIXEL_SCALE,\r\n              height: 90 * PIXEL_SCALE,\r\n              transform: \"translate(-50%, -50%)\",\r\n            }}\r\n          />\r\n          {/* Grid lines - Dynamic Scale */}\r\n          <div\r\n            className=\"absolute -translate-x-1/2 -translate-y-1/2 opacity-10 pointer-events-none\"\r\n            style={{\r\n              width: `${ROOM_SIZE_FT * PIXEL_SCALE * 4}px`,\r\n              height: `${ROOM_SIZE_FT * PIXEL_SCALE * 4}px`,\r\n              backgroundImage: `linear-gradient(#fff 1px, transparent 1px), linear-gradient(90deg, #fff 1px, transparent 1px)`,\r\n              backgroundSize: `${PIXEL_SCALE}px ${PIXEL_SCALE}px`,\r\n            }}\r\n          />\r\n\r\n          {/*  Boxes - High Z-Index to stay on top in Virtual World */}\r\n          {boxes.map(\r\n            (box) =>\r\n              !box.collected && (\r\n                <div\r\n                  key={box.id}\r\n                  onClick={(e) => {\r\n                    e.stopPropagation();\r\n                    onBoxClick(box);\r\n                  }}\r\n                  className=\"absolute text-7xl cursor-pointer pointer-events-auto active:scale-90 z-[100]\"\r\n                  style={{\r\n                    left: `${(box.x - ROOM_SIZE_FT / 2) * PIXEL_SCALE}px`,\r\n                    top: `${(box.y - ROOM_SIZE_FT / 2) * PIXEL_SCALE}px`,\r\n                    transform: \"translate(-50%, -50%)\",\r\n                    filter:\r\n                      nearestInfo.id === box.id\r\n                        ? \"drop-shadow(0 0 25px #fbbf24)\"\r\n                        : \"brightness(0.2)\",\r\n                  }}\r\n                >\r\n                  ðŸ“¦\r\n                </div>\r\n              ),\r\n          )}\r\n        </div>\r\n\r\n        {/*  Fixed Player Indicator (Stay in Center) */}\r\n        <div className=\"relative z-[10] pointer-events-none opacity-90\">\r\n          <div className=\"w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-2xl border-2 border-white/20\">\r\n            <div className=\"w-2.5 h-8 bg-blue-600 rounded-full mb-8\" />\r\n          </div>\r\n          <div\r\n            className=\"absolute -inset-8 border-t-4 border-yellow-400 rounded-full transition-transform\"\r\n            style={{ transform: `rotate(${nearestInfo.angle + 90}deg)` }}\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Popups (Inventory & Victory) */}\r\n      {showBag && (\r\n        <div\r\n          className=\"absolute inset-0 z-[300] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6\"\r\n          onClick={() => setShowBag(false)}\r\n        >\r\n          <div\r\n            className=\"bg-zinc-900 border border-white/10 w-full max-w-xs rounded-3xl p-6 shadow-2xl\"\r\n            onClick={(e) => e.stopPropagation()}\r\n          >\r\n            <div className=\"flex justify-between items-center mb-6\">\r\n              <h3 className=\"text-white font-bold uppercase text-xs tracking-widest\">\r\n                Inventory\r\n              </h3>\r\n              <button\r\n                onClick={() => setShowBag(false)}\r\n                className=\"text-zinc-500 text-xl\"\r\n              >\r\n                âœ•\r\n              </button>\r\n            </div>\r\n            <div className=\"grid grid-cols-3 gap-4\">\r\n              {[...Array(5)].map((_, i) => (\r\n                <div\r\n                  key={i}\r\n                  className={`aspect-square rounded-2xl flex items-center justify-center text-3xl ${inventory.includes(i) ? \"bg-yellow-500/20 border border-yellow-500\" : \"bg-zinc-800\"}`}\r\n                >\r\n                  {inventory.includes(i) ? \"ðŸ“¦\" : \"\"}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {inventory.length === BOX_COUNT && (\r\n        <div className=\"absolute inset-0 z-[400] bg-black flex flex-col items-center justify-center p-8\">\r\n          <div\r\n            ref={inventoryRef}\r\n            style={{\r\n              backgroundColor: \"#18181b\",\r\n              padding: \"40px\",\r\n              borderRadius: \"24px\",\r\n              display: \"flex\",\r\n              flexDirection: \"column\",\r\n              alignItems: \"center\",\r\n              border: \"1px solid rgba(255,255,255,0.1)\",\r\n            }}\r\n          >\r\n            <h2\r\n              style={{\r\n                color: \"#ffffff\",\r\n                fontWeight: \"900\",\r\n                fontSize: \"20px\",\r\n                marginBottom: \"20px\",\r\n              }}\r\n            >\r\n              MISSION COMPLETE\r\n            </h2>\r\n            <div\r\n              style={{\r\n                display: \"flex\",\r\n                gap: \"10px\",\r\n                justifyContent: \"center\",\r\n                flexWrap: \"wrap\",\r\n              }}\r\n            >\r\n              {inventory.map((boxId) => (\r\n                <span\r\n                  key={boxId}\r\n                  style={{\r\n                    fontSize: \"40px\",\r\n                    filter: \"drop-shadow(0 4px 6px rgba(0,0,0,0.3))\", // á€•á€¯á€¶á€œá€±á€¸ á€”á€Šá€ºá€¸á€”á€Šá€ºá€¸á€€á€¼á€½á€œá€¬á€¡á€±á€¬á€„á€º\r\n                  }}\r\n                >\r\n                  ðŸ“¦\r\n                </span>\r\n              ))}\r\n              {inventory && inventory.length < 1 && (\r\n                <span style={{ color: \"#52525b\", fontSize: \"14px\" }}>\r\n                  Empty Inventory\r\n                </span>\r\n              )}\r\n            </div>\r\n            <p\r\n              style={{ color: \"#71717a\", fontSize: \"12px\", marginTop: \"20px\" }}\r\n            >\r\n              RADAR VIRTUAL WORLD\r\n            </p>\r\n          </div>\r\n\r\n          <button\r\n            onClick={async () => {\r\n              const el = inventoryRef.current;\r\n              if (!el) return;\r\n\r\n              try {\r\n                const h2c = (await import(\"html2canvas\")).default;\r\n                const canvas = await h2c(el, {\r\n                  backgroundColor: \"#18181b\",\r\n                  scale: 2,\r\n                  useCORS: true,\r\n                  ignoreElements: (element) => element.tagName === \"IFRAME\",\r\n                });\r\n\r\n                const data = canvas.toDataURL(\"image/png\");\r\n                const link = document.createElement(\"a\");\r\n                link.href = data;\r\n                link.download = \"victory.png\";\r\n                link.click();\r\n              } catch (e) {\r\n                console.error(e);\r\n                alert(\r\n                  \"Capture failed again. Your browser might be forcing a dark mode filter.\",\r\n                );\r\n              }\r\n            }}\r\n            className=\"mt-10 bg-white text-black px-12 py-4 rounded-2xl font-black text-lg active:scale-95 transition-all\"\r\n          >\r\n            SAVE SCREENSHOT ðŸ“¸\r\n          </button>\r\n        </div>\r\n      )}\r\n\r\n      {/* Minimap */}\r\n      <div\r\n        className={`absolute bottom-10 right-6 w-28 h-28 bg-zinc-900/80 border rounded-2xl overflow-hidden pointer-events-none z-[200] ${isOutOfBounds ? \"border-red-500\" : \"border-white/10\"}`}\r\n      >\r\n        <div className=\"relative w-full h-full p-1\">\r\n          {boxes.map(\r\n            (box) =>\r\n              !box.collected && (\r\n                <div\r\n                  key={`m-${box.id}`}\r\n                  className={`absolute rounded-full ${nearestInfo.id === box.id ? \"w-2 h-2 bg-yellow-400 shadow-[0_0_5px_#fbbf24]\" : \"w-1 h-1 bg-white/40\"}`}\r\n                  style={{\r\n                    left: `${(box.x / ROOM_SIZE_FT) * 100}%`,\r\n                    top: `${(box.y / ROOM_SIZE_FT) * 100}%`,\r\n                    transform: \"translate(-50%, -50%)\",\r\n                  }}\r\n                />\r\n              ),\r\n          )}\r\n          <div\r\n            className={`absolute w-2 h-2 rounded-full border border-white ${isOutOfBounds ? \"bg-red-500\" : \"bg-blue-500\"}`}\r\n            style={{\r\n              left: `${(playerPosition.x / ROOM_SIZE_FT) * 100}%`,\r\n              top: `${(playerPosition.y / ROOM_SIZE_FT) * 100}%`,\r\n              transform: \"translate(-50%, -50%)\",\r\n            }}\r\n          />\r\n        </div>\r\n      </div>\r\n    </main>\r\n  );\r\n}\r\n"
        }
    ]
}